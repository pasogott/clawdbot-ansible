---
# macOS-specific system tools installation (Homebrew-based)

- name: Install essential system tools (macOS - Homebrew)
  community.general.homebrew:
    name:
      # Shells
      - zsh
      # Editors
      - vim
      - nano
      # Version control
      - git
      - git-lfs
      # Network tools
      - curl
      - wget
      - netcat
      - nmap
      - socat
      - telnet
      # Debugging tools
      - htop
      # System utilities
      - tmux
      - tree
      - jq
      - unzip
      - rsync
    state: present
  environment:
    PATH: "/opt/homebrew/bin:{{ ansible_env.PATH }}"

- name: Get current user shell (macOS)
  ansible.builtin.command: dscl . -read /Users/{{ openclaw_user }} UserShell
  register: current_shell
  changed_when: false
  failed_when: false

- name: Set zsh as default shell for openclaw user (macOS)
  ansible.builtin.command: chsh -s /bin/zsh {{ openclaw_user }}
  when: "'/bin/zsh' not in current_shell.stdout"
  changed_when: true

- name: Configure .zshrc for openclaw user (macOS)
  ansible.builtin.blockinfile:
    path: "{{ openclaw_home }}/.zshrc"
    marker: "# {mark} ANSIBLE MANAGED BLOCK - OpenClaw config"
    block: |
      # Enable 256 colors
      export TERM=xterm-256color
      export COLORTERM=truecolor

      # Add Homebrew to PATH (macOS)
      eval "$(/opt/homebrew/bin/brew shellenv)"

      # Add pnpm to PATH
      export PATH="{{ openclaw_home }}/.local/bin:$PATH"

      # Color support for common tools
      export CLICOLOR=1
      export LSCOLORS=ExFxCxDxBxegedabagacad

      # Aliases
      alias ls='ls -G'
      alias grep='grep --color=auto'
      alias ll='ls -lah'
    create: true
    owner: "{{ openclaw_user }}"
    mode: '0644'
